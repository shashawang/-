# ajax和跨域请求

原文链接：https://www.liaoxuefeng.com/wiki/001434446689867b27157e896e74d51a89c25cc8b43bdb3000/001434499861493e7c35be5e0864769a2c06afb4754acc6000

### ajax：

1. 是什么：用js执行异步网络请求
2. 为啥这么用：一次HTTP请求对应一个页面，所以要不刷新页面又要发送新请求更新页面，可以用js发送请求，收到数据再用js更新页面。
3. 早期应用：GMAIL
4. 特点：ajax；请求是异步执行的，通过回调函数获得响应
5. 使用：现代浏览器上写ajax主要依靠XMLHttpRequest。new一个XMLHttpRequest对象作为请求，给它的状态改变属性写一个函数判断有没获得结果，获得结果根据状态码再判断（还有古代浏览器？
6. 要了解啥：XMLHttpRequest对象/请求的属性、方法
7. open()方法：open(GET/POST，URL地址，默认异步true可省略)，参数3避免false，否则浏览器假死停止响应。用来干嘛的
8. send()： 真正发送请求。get不需要参数，post需要把body部分变成字符串或FormData对象
9. 例子：能看懂，但感觉字还写不出来。思路：ajax发送请求，对请求结果处理的函数中绑定请求成功和失败函数，成功和失败函数把相应内容写入请求文本域。请求按钮绑定
   低版本IE把var request = new XMLHttpRequest()换成var request = new ActiveXObject('Microsoft.XMLHTTP')就好。混在一起写用if判断，window.XMLHttpRequest就第一种，否则就第二种（window对象是否有该属性
10. **回调没看懂**？

### 安全限制：

1. 同源策略导致的：js发送ajax，url默认和当前页面url完全一致
2. 完全一致：域名完全相同、协议完全相同、端口号相同（少数浏览器可以不同
3. 那怎样请求外域（其他网站）资源？
   \1. 用flash绕过浏览器安全限制发送Http请求。但它比较麻烦
   \2. js把请求发到同源域名下的代理服务器，通过代理服务器转发请求、返回结果。（那服务器又怎么拿到外域资源呢？会不会有同样的问题）但服务器端要额外开发
   \3. 用**JSONP**。浏览器允许跨域js资源（可以在头部引用其他网站js链接）。但只能用get请求，且以函数调用的形式返回。
   用法：页面中写好函数，给页面添加动态script节点以动态读取外域js资源，接受回调结果
   案例：写好更新价格的函数（获取要更新的节点、写入）；触发函数，获取脚本元素节点和待更新元素节点，把一个新的url赋值给脚本元素资源属性，在待更新元素节点中添加获得的资源内容
4. 没懂的：被赋值给脚本元素Url中的?callback是用来指定页面的还是和之前的更新价格函数对应？

### CROS（跨域资源分享）：

1. h5规范定义的跨域访问资源的方式
2. 跨域能否成功，取决于对方服务器是否愿意给access-control-allow-origin设置包含本域
3. 好像**应该**把http请求的部分看、写一遍
4. 简单请求90%能被满足
5. 简单请求包括：GET、HEAD、POST，无自定义头。POST的内容类型content-type只能有三种
6. 支持h5的浏览器，引用外域资源时，除了js/css，都需要验证
7. 该咋办：ajax发送application/json的POST请求、PUT、DELETE等请求前，浏览器先发送OPTIONS请求，询问服务器接受的方法，access-control-allow-origin里包括将要请求的方法再发送，否则抛错。这几个方法很常见，服务器一般都支持
8. 终于知道请求里的options用来干嘛了
9. 安全限制和CROS的关系，安全限制是使用ajax发送请求时，请求方法中的链接参数即目标页面和当前页面不一样，那我不返回页面了，用js返回我要用的东西就好，反正是可以用外部资源的js的；跨域资源分享是请求方法是否被允许。都是ajax请求里的。

大概2h